#!/usr/bin/env bash
#=================================================================
# OmniTube v1.2a.023.w -- Scott Fleming
# scott@omnicommander.com
#=================================================================
# -- Variables to use -- 
source /home/pi/pi-tube/config.sh

echo "$TIMESTAMP Executing query for ${URL}${PI_UID}" > $fetchLog

/usr/bin/curl -s -H "Content-Type: application/json" -X GET "$URL$PI_UID" -o "/home/pi/pi-tube/json/file.json"

# use jq to parse array of json and load into arr
arr=( $(jq -r '.[].youtube_id' '/home/pi/pi-tube/json/file.json' ) )

echo "$TIMESTAMP ${PI_UID} currently has ${#arr[@]} asset files to download." >> $fetchLog

# clear vido directory of video files
echo "$TIMESTAMP Clearning $VIDEOPATH directory..." >> $fetchLog

rm $VIDEOPATH*

# iterate array and issue youtube-dl command for the id
for i in "${!arr[@]}"
  do
   
	echo "$TIMESTAMP Executing youtube-dl: ${i}_${PI_UID}_${arr[$i]}.mp4..." >> $fetchLog
	# --no-warnings --ignore-errors
	/usr/bin/youtube-dl --format mp4 --no-warnings --ignore-errors --ignore-config --prefer-ffmpeg https://www.youtube.com/watch?v=${arr[$i]} -o $VIDEOPATH${i}_${PI_UID}_${arr[$i]}.mp4

done

echo "$TIMESTAMP Executing vlc looper daemon..." >> $fetchlog

# Run the looper script
exec /home/pi/pi-tube/looper 







